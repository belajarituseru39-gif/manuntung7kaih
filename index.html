<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manuntung 7 KAIH (Multi Level)</title>

  <!-- FONTS: Fredoka (Rounded/Cartoon) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Varela+Round&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary: #0ea5e9; 
      --secondary: #8b5cf6;
      --accent: #f59e0b;
      --danger: #ef4444;
      --success: #10b981;
      --card-bg: #ffffff;
      --text-dark: #334155;
    }

    *{box-sizing:border-box}
    
    body{
      margin:0;
      font-family: 'Varela Round', sans-serif; 
      background: url('https://i.imgur.com/VH9TgSI.jpeg') no-repeat center center fixed;
      background-size: cover;
      color: var(--text-dark);
      overflow:hidden;
      user-select: none;
      -webkit-user-select: none;
    }

    .app{
      height:100vh;
      width:100vw;
      position:relative;
      background: rgba(255,255,255,0.1);
    }

    .screen{
      height:100%;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      position:relative;
    }

    /* --- CARTOON PANEL (Default) --- */
    .panel{
      width:min(900px, 100%);
      background: rgba(255, 255, 255, 0.95);
      color: var(--text-dark);
      border-radius: 40px; 
      padding: 24px;
      border: 8px solid rgba(255,255,255,0.5);
      box-shadow: 0 12px 0 rgba(0,0,0,0.1), 0 20px 40px rgba(0,0,0,0.2);
      position:relative;
      overflow:hidden;
      animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* --- START SCREEN SPECIAL --- */
    #screenStart .panel {
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        animation: none; 
    }
    
    #screenStart .box {
      margin: 24px auto;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 24px;
      border: 2px solid rgba(255, 255, 255, 0.6);
      max-width: 760px;
      color: white;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      text-align: center;
    }
    #screenStart .box h3 {
      margin:0 0 8px;
      font-family: 'Fredoka', sans-serif;
      font-size: 24px;
      color: #fff;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    #screenStart .box p {
      margin:0;
      font-size: 18px;
      line-height:1.6;
      font-weight: 600;
    }

    /* Credits */
    .credit-section {
        margin-top: 24px; 
        text-align: center; 
        padding: 10px 20px;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 99px;
        text-shadow: 0 1px 3px rgba(0,0,0,0.9);
        display: inline-flex;
        flex-wrap: wrap;
        justify-content: center;
        align-items: center;
        gap: 6px;
    }
    .credit-label {
        font-family:'Fredoka'; font-weight:600;
        color:#e0f2fe; font-size:13px; text-transform:uppercase; letter-spacing:0.05em;
    }
    .credit-name { font-weight:700; color:#fcd34d; font-size:15px; }
    .credit-school { font-size:14px; font-weight:600; color: #f1f5f9; }
    .credit-contact { font-size:13px; color:#bae6fd; font-weight:600; }
    .credit-sep { color: rgba(255,255,255,0.4); font-size: 14px; margin: 0 6px; }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* --- BUBBLE BUTTONS --- */
    .btn{
      border:none;
      cursor:pointer;
      font-family: 'Fredoka', sans-serif;
      font-weight:600;
      padding: 14px 32px;
      border-radius: 99px;
      color: white;
      background: var(--primary);
      box-shadow: 0 6px 0 #0284c7, 0 12px 20px rgba(0,0,0,0.2);
      transition: transform .1s ease, box-shadow .1s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      width:100%;
      max-width: 480px;
      font-size: clamp(20px, 2.5vw, 28px);
      border: 2px solid white;
    }
    .btn:hover{ transform: translateY(-2px); filter: brightness(1.05); }
    .btn:active{ transform: translateY(4px); box-shadow: 0 2px 0 #0284c7; }

    /* Topbar */
    .topbar{
      position:absolute;
      top:14px;
      right:14px;
      display:flex;
      gap:10px;
      z-index:150;
    }
    .pillbtn{
      border:none;
      cursor:pointer;
      padding: 10px 18px;
      border-radius: 20px;
      font-family: 'Fredoka', sans-serif;
      font-weight:600;
      font-size: 14px;
      background: white;
      color: #0f172a;
      box-shadow: 0 4px 0 #cbd5e1;
      border: 2px solid #e2e8f0;
      transition: all 0.1s;
    }
    .pillbtn:active { transform: translateY(4px); box-shadow: none; }
    .pillbtn.fs-active {
        background: #e0f2fe;
        color: #0284c7;
        border-color: #0284c7;
        box-shadow: 0 4px 0 #0284c7;
    }
    .pillbtn.fs-active:active { box-shadow:none; }

    /* Score Board */
    .score-board {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      z-index: 140; 
      pointer-events: none;
    }
    .score-pill {
      background: white;
      border: 4px solid white;
      border-radius: 99px;
      padding: 6px 16px 6px 6px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 0 rgba(0,0,0,0.1);
      color: #334155;
      pointer-events: auto;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .score-pill img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: #f1f5f9;
      border: 2px solid #e2e8f0;
    }
    .score-pill span {
      display:flex;
      flex-direction:column;
      line-height:1;
    }
    .score-val {
      font-family: 'Fredoka', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: #0f172a;
    }
    .score-pill.active {
      transform: scale(1.15) translateY(4px);
      border-color: var(--accent);
      z-index: 10;
    }

    /* Grid & Cards */
    .grid3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:20px;
      margin-top:24px;
    }
    @media (max-width: 860px){
      .grid3{ grid-template-columns: 1fr; }
    }
    .card{
      background: #fff;
      border-radius: 24px;
      padding: 20px;
      border: 4px solid #f1f5f9;
      box-shadow: 0 8px 0 #e2e8f0;
      cursor:pointer;
      transition: all .1s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .card:active{ transform: translateY(6px); box-shadow: 0 2px 0 #e2e8f0; }
    
    .bigNum{
      font-family: 'Fredoka', sans-serif;
      font-size: 52px;
      font-weight: 700;
      color: var(--primary);
      line-height:1;
    }
    .smallCaps{
      font-family: 'Fredoka', sans-serif;
      font-weight:600;
      color:#64748b;
      letter-spacing:.05em;
      text-transform:uppercase;
      font-size: 13px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .back{
      background: #f1f5f9;
      color:#334155;
      border: 2px solid #cbd5e1;
      padding:10px 18px;
      border-radius: 99px;
      font-family: 'Fredoka', sans-serif;
      font-weight:600;
      font-size: 14px;
      cursor:pointer;
    }
    .back:hover { background: white; border-color: var(--primary); color: var(--primary); }

    /* Level Selection Grid */
    .levelGrid {
        display:grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-top: 24px;
    }
    .levelCard {
        background: #f8fafc;
        border-radius: 24px;
        padding: 24px;
        border: 4px solid #e2e8f0;
        box-shadow: 0 6px 0 #cbd5e1;
        text-align:center;
        cursor:pointer;
        transition: all 0.1s;
    }
    .levelCard:active { transform: translateY(4px); box-shadow: 0 2px 0 #cbd5e1; }
    .levelCard h3 {
        margin: 0; font-family: 'Fredoka'; font-size: 32px; color: #0f172a;
    }
    .levelCard p {
        margin: 8px 0 0; font-size: 13px; font-weight: 600; color: #64748b; line-height: 1.3;
    }
    .levelCard[data-level="SD"]:hover { border-color: #fca5a5; background: #fef2f2; }
    .levelCard[data-level="SMP"]:hover { border-color: #93c5fd; background: #eff6ff; }
    .levelCard[data-level="SMA"]:hover { border-color: #fde047; background: #fefce8; }


    /* Characters */
    .charWrap{
      display:flex;
      gap:20px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:20px;
    }
    .charCard{
      width: min(240px, 100%);
      background: white;
      border-radius: 24px;
      padding: 16px;
      border: 4px solid white;
      box-shadow: 0 8px 0 rgba(0,0,0,0.1);
      cursor:pointer;
      transition: all .1s ease;
      position:relative;
    }
    .charCard:active{ transform: translateY(6px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
    .charCard.disabled{
      opacity:.6;
      filter: grayscale(1);
      cursor:not-allowed;
    }
    .charImg{
      height: 140px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      margin-bottom:12px;
    }
    .charImg img{
      height:100%;
      object-fit:contain;
      filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2));
    }
    .charName{
      text-align:center;
      font-family: 'Fredoka', sans-serif;
      font-weight:700;
      font-size: 24px;
      margin:0;
      color:#0f172a;
    }
    .charStyle{
      text-align:center;
      margin:4px 0 0;
      font-weight:600;
      font-size: 12px;
      color: #64748b;
    }
    .pickedBadge{
      position:absolute;
      inset:0;
      background: rgba(255,255,255,0.7);
      border-radius: 20px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: 'Fredoka', sans-serif;
      font-weight:700;
      color: var(--success);
      font-size: 24px;
      backdrop-filter: blur(2px);
      text-shadow: 0 2px 0 white;
      border: 4px solid var(--success);
    }

    /* Map Layout */
    .mapLayout{
      height:100%;
      width:100%;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding:14px;
    }
    
    .mapArea{
      flex:1;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 24px;
      overflow:hidden;
      position:relative;
      border: 6px solid rgba(255,255,255,0.6);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .mapArea img{
      width:100%;
      height:100%;
      object-fit:cover;
      opacity:.95;
      transform: scale(1.02);
    }

    .node{
      position:absolute;
      transform: translate(-50%, -50%);
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display:flex;
      align-items:center;
      justify-content:center;
      border: 4px solid white;
      box-shadow: 0 6px 0 rgba(0,0,0,0.2);
      cursor:pointer;
      user-select:none;
      font-family: 'Fredoka', sans-serif;
      font-weight:700;
      font-size: 24px;
      color:#0f172a;
      transition: transform 0.1s;
      background: #fcd34d;
      z-index: 10;
    }
    .node:active { transform: translate(-50%, -50%) translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
    
    .node.locked{
      background: #94a3b8;
      border-color: #cbd5e1;
      color: #e2e8f0;
      cursor:not-allowed;
    }
    .node.done{
      background: var(--success);
      color:white;
      border-color: #6ee7b7;
    }
    .node.next{
      background: var(--accent);
      border-color: #fde68a;
      animation: bounce 2s infinite;
    }
    @keyframes bounce{
      0%, 20%, 50%, 80%, 100% {transform: translate(-50%, -50%) translateY(0);}
      40% {transform: translate(-50%, -50%) translateY(-10px);}
      60% {transform: translate(-50%, -50%) translateY(-5px);}
    }

    .label{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top: 110%;
      background: white;
      color: var(--text-dark);
      border-radius: 12px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      border: 2px solid #e2e8f0;
      white-space:nowrap;
      opacity:0;
      transition: all .2s ease;
      pointer-events:none;
      z-index: 20;
    }
    .node:hover .label{ opacity:1; top: 120%; }

    /* Bottom Sidebar */
    .sidebar{
      width: 100%;
      background: white;
      border-radius: 24px;
      border: 4px solid rgba(255,255,255,0.8);
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      color:#0f172a;
      display:flex;
      flex-direction:row;
      align-items:center;
      height: 90px;
      padding: 0 16px;
      gap: 16px;
    }
    .sideInfo {
        display:flex;
        flex-direction:column;
        justify-content:center;
        min-width: 100px;
    }
    .progressBar{
      flex:1;
      height: 16px;
      background: #e2e8f0;
      border-radius: 99px;
      overflow:hidden;
      border: 2px solid #cbd5e1;
      max-width: 200px;
    }
    .progressFill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #fcd34d, #f59e0b);
      transition: width .6s ease;
    }
    .materials{
      flex: 2;
      display:flex;
      gap: 10px;
      overflow-x: auto;
      padding: 4px;
      height: 100%;
      align-items:center;
    }
    .materials::-webkit-scrollbar { height: 0px; }

    .matItem{
      background: #f0f9ff;
      border: 2px solid #bae6fd;
      border-radius: 12px;
      padding: 6px 12px;
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
      color:#0369a1;
      font-size: 12px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .tagOk{
      background: var(--success);
      color: white;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 10px;
    }

    /* Modal quiz */
    .modal{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:200;
    }
    .modal.show{ display:flex; }
    .modalCard{
      width:min(900px, 100%);
      height:min(92vh, 700px);
      border-radius: 30px;
      overflow:hidden;
      border: 8px solid white;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      position:relative;
      background-size:cover;
      background-position:center;
    }
    .modalOverlay{
      position:absolute;
      inset:0;
      background: rgba(255,255,255,0.9);
    }
    .modalInner{
      position:relative;
      z-index:2;
      height:100%;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding: 20px;
      gap:12px;
    }
    .closeBtn{
      border:none;
      cursor:pointer;
      background: #f1f5f9;
      color: #64748b;
      padding:10px 14px;
      border-radius:999px;
      font-family: 'Fredoka', sans-serif;
      font-weight:700;
      border: 2px solid #cbd5e1;
      transition: all 0.1s;
    }
    .closeBtn:active { transform: scale(0.95); }

    .quizArea{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      padding: 20px;
      gap:16px;
      max-width: 800px;
      margin:0 auto;
      width:100%;
    }
    .badge{
      width:fit-content;
      margin:0 auto;
      padding: 8px 16px;
      border-radius: 99px;
      background: #e0f2fe;
      border: 2px solid #38bdf8;
      color: #0284c7;
      font-family: 'Fredoka', sans-serif;
      font-weight:700;
      font-size:14px;
    }
    .qText{
      text-align:center;
      font-family: 'Fredoka', sans-serif;
      font-weight:700;
      font-size: clamp(22px, 3.5vw, 40px);
      line-height:1.3;
      margin:0;
      color: #1e293b;
    }
    .optBtn{
      width:100%;
      border:none;
      cursor:pointer;
      border-radius: 16px;
      padding: 16px 20px;
      font-weight:600;
      text-align:left;
      background: white;
      color: #334155;
      border: 3px solid #e2e8f0;
      box-shadow: 0 4px 0 #cbd5e1;
      transition: all .1s ease;
      font-size: 18px;
    }
    .optBtn:active{ 
        transform: translateY(4px); 
        box-shadow: none;
    }
    .optBtn.good{ 
        background: #dcfce7; 
        border-color: #22c55e; 
        color: #15803d;
        box-shadow: 0 4px 0 #16a34a;
    }
    .optBtn.bad{ 
        background: #fee2e2; 
        border-color: #ef4444; 
        color: #b91c1c;
        box-shadow: 0 4px 0 #b91c1c;
    }
    .optBtn.dim{ opacity:.5; box-shadow:none; border-color:#e2e8f0; }

    /* Small Pop-up for Turn */
    .turnPopup{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:250;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
    }
    .turnPopup.show{ display:flex; }
    .turnCard{
      width: 320px; /* Small size */
      background: white;
      color:#0f172a;
      border-radius: 24px;
      padding: 16px;
      border: 6px solid #fcd34d;
      text-align:center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .turnCard img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: #f1f5f9;
        margin-bottom: 8px;
    }
    .musicBtn{
      position:absolute;
      left:14px;
      bottom:110px; /* Adjusted due to bottom sidebar */
      z-index:120;
      border:none;
      cursor:pointer;
      padding: 10px 14px;
      border-radius: 99px;
      background: white;
      color:#0f172a;
      font-family: 'Fredoka', sans-serif;
      font-weight:700;
      box-shadow: 0 4px 0 rgba(0,0,0,0.1);
      border: 2px solid #e2e8f0;
      font-size: 12px;
    }

    /* Finish Screen Overlay Styles */
    #screenFinish {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(10px);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
    }
    .finishCard {
      background: rgba(255,255,255,0.95);
      border-radius: 40px;
      padding: 40px;
      text-align: center;
      border: 8px solid #fcd34d;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      max-width: 600px;
      width: 90%;
      animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
    }
    .winnerSection {
      margin-bottom: 30px;
    }
    .winnerAvatar {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: 8px solid #f59e0b;
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
      margin-bottom: 16px;
      background: #fff;
    }
    .winnerTitle {
      font-family: 'Fredoka', sans-serif;
      font-weight: 700;
      font-size: 24px;
      color: #64748b;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .winnerRank {
      font-family: 'Fredoka', sans-serif;
      font-weight: 700;
      font-size: 36px;
      color: #0ea5e9;
      margin-bottom: 10px;
      text-transform: uppercase;
      text-shadow: 2px 2px 0px #bae6fd;
    }
    .winnerName {
      font-family: 'Fredoka', sans-serif;
      font-size: 42px;
      font-weight: 700;
      color: #0f172a;
    }
    .scoreTable {
      background: #f8fafc;
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 24px;
      border: 2px solid #e2e8f0;
    }
    .scoreRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border-bottom: 2px solid #e2e8f0;
    }
    .scoreRow:last-child { border-bottom: none; }
    .scoreRow img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 12px;
      border: 2px solid #cbd5e1;
    }
    .scoreRow .pName {
      font-weight: 700;
      color: #334155;
      flex: 1;
      text-align: left;
      font-family: 'Fredoka', sans-serif;
      font-size: 18px;
    }
    .scoreRow .pScore {
      font-weight: 700;
      font-size: 24px;
      color: #0ea5e9;
      font-family: 'Fredoka', sans-serif;
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <!-- SCORE BOARD: Centered Top (Hidden on Start) -->
    <div class="score-board" id="scoreBoard" style="display:none;">
      <!-- Populated by JS -->
    </div>

    <!-- TOPBAR -->
    <div class="topbar">
      <button class="pillbtn" id="btnFull">‚õ∂ LAYAR PENUH</button>
      <button class="pillbtn" id="btnReset" style="display:none;">MENU</button>
    </div>

    <button class="musicBtn" id="btnMusic" style="display:none;">üîá Musik</button>

    <!-- START -->
    <div class="screen" id="screenStart">
      <div class="panel">
        
        <!-- LOGO GAME -->
        <img src="https://i.imgur.com/ZuL2Tgw.jpeg" alt="Logo Manuntung 7 KAIH" style="max-width:160px; width:100%; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.4); display:block; margin: 0 auto 12px; border: 3px solid rgba(255,255,255,0.8);">

        <div class="box" style="text-align: center; margin-top:0;">
          <h3 style="margin-top:0;">üó∫Ô∏è MISI TIM KAMU</h3>
          <p>
            Halo Arsitek Muda! Tugas kalian adalah membangun <b>Rumah Anak Hebat Indonesia</b>.
            Jelajahi 7 Pulau Emas, kumpulkan material dengan menjawab kuis, dan bangun masa depan yang cerah!
          </p>
        </div>

        <div style="display:flex; justify-content:center; margin-top:20px;">
          <button class="btn" id="btnStart">‚ñ∂ MULAI PETUALANGAN</button>
        </div>

        <!-- INFO KREDIT -->
        <div style="text-align:center;">
          <div class="credit-section">
            <div class="credit-label">Ide Permainan:</div>
            <div class="credit-name">Abdul Rahmat, S.Pd</div>
            <div class="credit-sep">|</div>
            <div class="credit-school">SDN 011 Balikpapan Tengah</div>
            <div class="credit-sep">|</div>
            <div class="credit-contact">WA: 081351767574</div>
          </div>
        </div>

      </div>
    </div>

    <!-- LEVEL SELECTION -->
    <div class="screen" id="screenLevel" style="display:none;">
      <div class="panel">
        <div class="row">
          <button class="back" id="btnBackToStart">‚Üê KEMBALI</button>
        </div>
        <h2 class="title" style="font-size:clamp(24px, 4vw, 42px); margin-top:16px;">PILIH JENJANG</h2>
        <div class="subtitle" style="margin-bottom:16px; background:#e0f2fe; color:#0284c7; border:2px solid #7dd3fc;">Sesuaikan Tingkat Kesulitan</div>

        <div class="levelGrid">
            <div class="levelCard" onclick="selectLevel('SD')" data-level="SD">
                <h3>SD</h3>
                <p>Tebak Kegiatan<br>& Manfaat</p>
            </div>
            <div class="levelCard" onclick="selectLevel('SMP')" data-level="SMP">
                <h3>SMP</h3>
                <p>Hubungan<br>Kebiasaan - Manfaat</p>
            </div>
            <div class="levelCard" onclick="selectLevel('SMA')" data-level="SMA">
                <h3>SMA</h3>
                <p>Analisis Masalah<br>& Solusi</p>
            </div>
        </div>
      </div>
    </div>

    <!-- MODE -->
    <div class="screen" id="screenMode" style="display:none;">
      <div class="panel">
        <div class="row">
          <button class="back" id="btnBackToLevel">‚Üê KEMBALI</button>
        </div>
        <h2 class="title" style="font-size:clamp(24px, 4vw, 42px); margin-top:16px;">PILIH JUMLAH ARSITEK</h2>

        <div class="grid3">
          <div class="card" data-mode="1">
            <div>
              <div class="bigNum">1</div>
              <div class="smallCaps">PEMAIN</div>
            </div>
            <div style="font-size:40px;">üë§</div>
          </div>
          <div class="card" data-mode="2">
            <div>
              <div class="bigNum">2</div>
              <div class="smallCaps">PEMAIN</div>
            </div>
            <div style="font-size:40px;">üë•</div>
          </div>
          <div class="card" data-mode="3">
            <div>
              <div class="bigNum">3</div>
              <div class="smallCaps">PEMAIN</div>
            </div>
            <div style="font-size:40px;">üë§üë•</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHARACTER -->
    <div class="screen" id="screenChar" style="display:none;">
      <div class="panel">
        <div class="row">
          <button class="back" id="btnBackToMode">‚Üê KEMBALI</button>
          <div class="subtitle" id="pickInfo" style="background:#e0f2fe; color:#0284c7; border:2px solid #7dd3fc;">Pemain 1, pilih jagoanmu!</div>
        </div>

        <h2 class="title" style="font-size:clamp(24px, 4vw, 42px); margin-top:16px;">PILIH KARAKTER</h2>

        <div class="charWrap" id="charWrap"></div>

        <div style="display:flex; justify-content:center; gap:8px; margin-top:20px;" id="pickDots"></div>
      </div>
    </div>

    <!-- MAP -->
    <div class="screen" id="screenMap" style="display:none; padding:0;">
      <div class="mapLayout">
        <div class="mapArea" id="mapArea">
          <img alt="Peta Jelajah" src="https://i.imgur.com/2UJgnUQ.jpeg">
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
          <div class="sideInfo">
             <div class="smallCaps">SKOR TOTAL</div>
             <div style="font-family:'Fredoka'; font-weight:700; font-size:24px; color:#0f172a;" id="totalScore">0</div>
          </div>
          
          <div style="display:flex; flex-direction:column; justify-content:center; gap:4px;">
             <div class="smallCaps">PROGRESS</div>
             <div class="progressBar">
               <div class="progressFill" id="progressFill"></div>
             </div>
          </div>

          <div class="materials" id="materials">
            <!-- Items will scroll horizontally here -->
          </div>
        </div>
      </div>
    </div>

    <!-- FINISH SCREEN -->
    <div id="screenFinish" style="display:none;">
        <div class="finishCard">
            <div id="finishContent"></div>
        </div>
    </div>

    <!-- MODAL QUIZ -->
    <div class="modal" id="modal">
      <div class="modalCard" id="modalCard">
        <div class="modalOverlay"></div>

        <div class="turnPopup" id="turnPopup">
          <div class="turnCard">
            <div class="small" style="font-family:'Fredoka'; font-weight:700; color:#94a3b8;">GANTI GILIRAN</div>
            <div style="margin:8px 0;">
              <img id="turnImg" alt="player">
            </div>
            <div style="font-family:'Fredoka'; font-weight:700; font-size:20px;">
              <span id="turnName" style="color:#0ea5e9;">Pemain</span>
            </div>
            <div style="color:#64748b; font-size:14px; font-weight:600; margin:4px 0 12px;">Siap menjawab 3 pertanyaan?</div>
            <button class="btn" style="max-width:100%; font-size:16px; padding:10px;" id="btnTurnReady">SIAP! üëç</button>
          </div>
        </div>

        <div class="modalInner">
          <div class="modalHead">
            <button class="closeBtn" id="btnCloseModal">‚úï Keluar</button>
            <div style="text-align:right;">
              <div class="smallCaps" id="islandName" style="color:#0369a1;">Pulau</div>
              <div style="font-family:'Fredoka'; font-weight:700; font-size:28px; color:#0f172a;" id="islandHabit">Kebiasaan</div>
            </div>
          </div>

          <div class="quizArea">
            <div class="badge" id="quizBadge">TEBAK KEGIATAN</div>
            <h3 class="qText" id="qText">Pertanyaan...</h3>

            <div style="display:grid; gap:12px;" id="options"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CUSTOM CONFIRM MODAL (Ditambahkan untuk dukungan iframe Canvas) -->
    <div id="customConfirmModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); z-index:99999; align-items:center; justify-content:center;">
      <div style="background:white; padding:24px; border-radius:24px; text-align:center; max-width:340px; border:6px solid #ef4444; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <h3 style="font-family:'Fredoka', sans-serif; font-size:24px; margin:0 0 12px; color:#0f172a;">Kembali ke Menu?</h3>
        <p style="margin:0 0 20px; color:#64748b; font-weight:600;">Progress saat ini akan hilang dan di-reset.</p>
        <div style="display:flex; gap:12px;">
          <button style="flex:1; padding:12px; border-radius:99px; border:2px solid #cbd5e1; background:#f1f5f9; color:#475569; font-weight:700; cursor:pointer;" onclick="document.getElementById('customConfirmModal').style.display='none'">Batal</button>
          <button style="flex:1; padding:12px; border-radius:99px; border:none; background:#ef4444; color:white; font-weight:700; cursor:pointer; box-shadow:0 4px 0 #b91c1c;" onclick="executeReset()">Ya, Keluar</button>
        </div>
      </div>
    </div>

  </div>

<script>
  // ===== AUDIO SFX SYNTHESIZER (Tanpa File Eksternal) =====
  let audioCtx;
  function initAudioContext() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }
  }

  function playSfx(type) {
    if (!audioCtx) return;
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    if (type === 'correct') {
      // Bunyi ping ceria
      osc.type = 'sine';
      osc.frequency.setValueAtTime(800, t);
      osc.frequency.exponentialRampToValueAtTime(1200, t + 0.1);
      gain.gain.setValueAtTime(0.3, t);
      gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
      osc.start(t);
      osc.stop(t + 0.3);
    } else if (type === 'wrong') {
      // Bunyi boop rendah
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(150, t);
      osc.frequency.linearRampToValueAtTime(100, t + 0.3);
      gain.gain.setValueAtTime(0.3, t);
      gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
      osc.start(t);
      osc.stop(t + 0.3);
    } else if (type === 'island') {
      // Arpeggio kemenangan level
      osc.type = 'square';
      osc.frequency.setValueAtTime(400, t);
      osc.frequency.setValueAtTime(500, t + 0.1);
      osc.frequency.setValueAtTime(600, t + 0.2);
      osc.frequency.setValueAtTime(800, t + 0.3);
      gain.gain.setValueAtTime(0.15, t);
      gain.gain.linearRampToValueAtTime(0.01, t + 0.6);
      osc.start(t);
      osc.stop(t + 0.6);
    } else if (type === 'win') {
      // Fanfare Kemenangan total
      osc.type = 'triangle';
      osc.frequency.setValueAtTime(523.25, t); // C5
      osc.frequency.setValueAtTime(659.25, t + 0.15); // E5
      osc.frequency.setValueAtTime(783.99, t + 0.3); // G5
      osc.frequency.setValueAtTime(1046.50, t + 0.45); // C6
      gain.gain.setValueAtTime(0.3, t);
      gain.gain.linearRampToValueAtTime(0.01, t + 1.5);
      osc.start(t);
      osc.stop(t + 1.5);
    }
  }

  // ===== DATA =====
  const MUSIC_URL = "https://github.com/belajarituseru39-gif/dpl-game/raw/refs/heads/main/Tujuh%20Kebiasaan%20Anak%20Indonesia%20Hebat.mp3";

  const HABIT_DATA = {
    ISL_01: {
      name: "Pulau Embun Pagi",
      habit: "Bangun Pagi",
      sd: {
        acts: ["Bangun pagi tepat waktu", "Merapikan tempat tidur", "Membersihkan diri", "Sarapan sebelum beraktivitas"],
        bens: ["Meningkatkan kedisiplinan", "Melatih kemampuan mengelola waktu", "Meningkatkan pengendalian diri", "Menjaga keseimbangan jiwa dan raga", "Mendukung kesuksesan belajar dan aktivitas harian"]
      },
      smp: [
        { q: "Merapikan tempat tidur setelah bangun adalah contoh...", a: "Meningkatkan kedisiplinan" },
        { q: "Apa manfaat dari bangun pagi tepat waktu?", a: "Mendukung kesuksesan belajar dan aktivitas harian" },
        { q: "Kebiasaan bangun pagi berhubungan erat dengan...", a: "Melatih kemampuan mengelola waktu" },
        { q: "Apa dampak positif dari membersihkan diri setelah bangun?", a: "Menjaga keseimbangan jiwa dan raga" },
        { q: "Sarapan sebelum beraktivitas bertujuan untuk...", a: "Meningkatkan pengendalian diri dan fokus" }
      ],
      sma: [
        { prob: "Andi sering terlambat karena manajemen waktu yang buruk.", sol: "Bangun pagi tepat waktu untuk melatih pengelolaan waktu.", wrong: ["Tidur lebih larut agar bangun siang", "Menyalahkan jam alarm"] },
        { prob: "Sinta merasa harinya tidak produktif dan berantakan.", sol: "Mulai hari dengan merapikan tempat tidur untuk disiplin.", wrong: ["Langsung main HP di kasur", "Membiarkan kamar berantakan"] },
        { prob: "Budi sulit fokus belajar di sekolah.", sol: "Sarapan sebelum beraktivitas untuk energi dan fokus.", wrong: ["Jajan sembarangan di sekolah", "Menahan lapar sampai siang"] }
      ]
    },
    ISL_02: {
      name: "Pulau Kubah Cahaya",
      habit: "Beribadah",
      sd: {
        acts: ["Shalat/sembahyang", "Berdoa sesuai agama masing-masing", "Membaca kitab suci", "Rutin ke tempat ibadah"],
        bens: ["Mendekatkan hubungan individu dengan Tuhan", "Meningkatkan nilai etika, moral, spiritual, dan sosial", "Membantu memahami tujuan hidup yang bermakna", "Menumbuhkan kebersamaan dan solidaritas", "Mendukung pengembangan diri berkelanjutan"]
      },
      smp: [
        { q: "Apa manfaat utama dari rutin ke tempat ibadah?", a: "Menumbuhkan kebersamaan dan solidaritas" },
        { q: "Membaca kitab suci bertujuan untuk...", a: "Meningkatkan nilai etika, moral, dan spiritual" },
        { q: "Apa dampak dari berdoa sesuai agama masing-masing?", a: "Mendekatkan hubungan individu dengan Tuhan" },
        { q: "Kegiatan beribadah membantu kita dalam...", a: "Memahami tujuan hidup yang bermakna" },
        { q: "Kebiasaan beribadah mendukung...", a: "Pengembangan diri berkelanjutan" }
      ],
      sma: [
        { prob: "Rani merasa hampa dan kehilangan arah tujuan hidup.", sol: "Mendalami ibadah untuk memahami tujuan hidup bermakna.", wrong: ["Mencari hiburan sesaat", "Mengurung diri di kamar"] },
        { prob: "Terjadi konflik antar kelompok di lingkungan sekolah.", sol: "Perkuat ibadah untuk meningkatkan solidaritas dan etika sosial.", wrong: ["Ikut memanaskan suasana", "Masa bodoh dengan lingkungan"] },
        { prob: "Budi ingin menjadi pribadi yang lebih baik secara moral.", sol: "Rutin membaca kitab suci dan beribadah.", wrong: ["Hanya fokus pada nilai akademik", "Meniru gaya hidup selebriti"] }
      ]
    },
    ISL_03: {
      name: "Pulau Ladang Gizi",
      habit: "Makan Sehat Bergizi",
      sd: {
        acts: ["Sarapan", "Makan siang dan malam teratur", "Mengonsumsi makanan bergizi seimbang"],
        bens: ["Menjaga kesehatan fisik sebagai investasi jangka panjang", "Memaksimalkan potensi tubuh dan pikiran", "Menumbuhkan tanggung jawab terhadap kesehatan diri", "Meningkatkan kemandirian anak"]
      },
      smp: [
        { q: "Mengapa kita perlu makan siang dan malam teratur?", a: "Untuk menjaga kesehatan fisik jangka panjang" },
        { q: "Apa manfaat mengonsumsi makanan bergizi seimbang?", a: "Memaksimalkan potensi tubuh dan pikiran" },
        { q: "Kebiasaan makan sehat menumbuhkan sikap...", a: "Tanggung jawab terhadap kesehatan diri" },
        { q: "Sarapan pagi secara mandiri dapat...", a: "Meningkatkan kemandirian anak" },
        { q: "Investasi jangka panjang dari makan sehat adalah...", a: "Kesehatan fisik yang terjaga" }
      ],
      sma: [
        { prob: "Tubuh sering lemas dan pikiran sulit fokus saat ujian.", sol: "Konsumsi makanan bergizi untuk maksimalkan potensi tubuh.", wrong: ["Minum suplemen energi berlebih", "Belajar tanpa istirahat"] },
        { prob: "Ingin hidup sehat di masa tua nanti.", sol: "Jaga pola makan sehat sebagai investasi jangka panjang.", wrong: ["Diet ketat saat sudah sakit", "Makan apa saja selagi muda"] },
        { prob: "Sering sakit perut karena jajan sembarangan.", sol: "Bertanggung jawab pada kesehatan diri dengan bawa bekal.", wrong: ["Menyalahkan penjual makanan", "Minum obat terus menerus"] }
      ]
    },
    ISL_04: {
      name: "Pulau Gelanggang Juara",
      habit: "Berolahraga",
      sd: {
        acts: ["Senam bersama", "Permainan olahraga", "Lari pagi/sore atau bersepeda", "Mengikuti kegiatan menari atau aktivitas fisik lain"],
        bens: ["Menjaga kesehatan fisik dan mental", "Meningkatkan kebugaran tubuh", "Mengembangkan potensi diri", "Menumbuhkan nilai sportivitas"]
      },
      smp: [
        { q: "Permainan olahraga beregu melatih kita untuk...", a: "Menumbuhkan nilai sportivitas" },
        { q: "Apa manfaat dari lari pagi atau bersepeda?", a: "Meningkatkan kebugaran tubuh" },
        { q: "Mengikuti kegiatan menari bermanfaat untuk...", a: "Mengembangkan potensi diri" },
        { q: "Senam bersama bertujuan utama untuk...", a: "Menjaga kesehatan fisik dan mental" },
        { q: "Nilai positif dari kompetisi olahraga adalah...", a: "Sportivitas dan kejujuran" }
      ],
      sma: [
        { prob: "Merasa stress dengan tugas sekolah yang menumpuk.", sol: "Lakukan senam atau lari untuk kesehatan mental.", wrong: ["Tidur seharian", "Marah-marah pada teman"] },
        { prob: "Tubuh terasa kaku dan mudah lelah.", sol: "Rutin lari pagi atau bersepeda untuk kebugaran.", wrong: ["Duduk terus di depan laptop", "Pijat setiap hari"] },
        { prob: "Sulit menerima kekalahan dalam lomba.", sol: "Ikuti permainan olahraga untuk latih sportivitas.", wrong: ["Protes keras pada juri", "Berhenti ikut lomba"] }
      ]
    },
    ISL_05: {
      name: "Pulau Pustaka Ilmu",
      habit: "Gemar Belajar",
      sd: {
        acts: ["Rajin bersekolah", "Membuat kerajinan", "Menyimak konten pembelajaran", "Rajin membaca"],
        bens: ["Mendukung pengembangan diri", "Menumbuhkan kreativitas dan imajinasi", "Menambah pengetahuan dan wawasan", "Membentuk sikap rendah hati dan empati"]
      },
      smp: [
        { q: "Apa manfaat utama dari rajin membaca?", a: "Menambah pengetahuan dan wawasan" },
        { q: "Membuat kerajinan tangan melatih...", a: "Kreativitas dan imajinasi" },
        { q: "Rajin bersekolah dan belajar bertujuan untuk...", a: "Mendukung pengembangan diri" },
        { q: "Menyimak konten pembelajaran dapat membantu...", a: "Membentuk sikap rendah hati dan empati" },
        { q: "Pengembangan diri didapat melalui...", a: "Konsistensi dalam belajar" }
      ],
      sma: [
        { prob: "Merasa kurang ide dalam mengerjakan proyek seni.", sol: "Buat kerajinan untuk asah kreativitas dan imajinasi.", wrong: ["Meniru karya orang lain", "Membeli karya jadi"] },
        { prob: "Sering merasa paling pintar dan meremehkan orang.", sol: "Simak konten pembelajaran untuk latih rendah hati.", wrong: ["Debat tanpa dasar", "Menutup diri dari ilmu baru"] },
        { prob: "Ingin wawasan luas untuk bekal masa depan.", sol: "Rajin membaca berbagai sumber pengetahuan.", wrong: ["Hanya baca status medsos", "Menunggu info dari teman"] }
      ]
    },
    ISL_06: {
      name: "Pulau Desa Madani",
      habit: "Bermasyarakat",
      sd: {
        acts: ["Bermain dengan tetangga", "Mengikuti kerja bakti", "Menjenguk orang sakit", "Mengunjungi tempat umum"],
        bens: ["Menumbuhkan nilai gotong royong dan kerja sama", "Mengembangkan sikap saling menghormati dan toleransi", "Menanamkan keadilan dan kesetaraan", "Meningkatkan tanggung jawab terhadap lingkungan", "Menciptakan rasa gembira dan kebersamaan"]
      },
      smp: [
        { q: "Mengikuti kerja bakti adalah wujud dari...", a: "Nilai gotong royong dan kerja sama" },
        { q: "Bermain dengan tetangga dapat menciptakan...", a: "Rasa gembira dan kebersamaan" },
        { q: "Mengunjungi tempat umum melatih kita untuk...", a: "Mengembangkan sikap saling menghormati dan toleransi" },
        { q: "Menjenguk orang sakit menanamkan nilai...", a: "Keadilan, kesetaraan, dan empati" },
        { q: "Tanggung jawab terhadap lingkungan tumbuh melalui...", a: "Partisipasi dalam kegiatan masyarakat" }
      ],
      sma: [
        { prob: "Lingkungan sekitar rumah kotor dan tidak terawat.", sol: "Ikuti kerja bakti sebagai tanggung jawab lingkungan.", wrong: ["Menyalahkan petugas kebersihan", "Pindah rumah"] },
        { prob: "Merasa asing dan tidak kenal tetangga.", sol: "Bermain atau berinteraksi dengan tetangga (Kebersamaan).", wrong: ["Mengurung diri di rumah", "Hanya berteman online"] },
        { prob: "Melihat teman yang sedang sakit.", sol: "Menjenguknya untuk tunjukkan solidaritas dan kesetaraan.", wrong: ["Kirim pesan singkat saja", "Pura-pura tidak tahu"] }
      ]
    },
    ISL_07: {
      name: "Pulau Bintang Tenang",
      habit: "Tidur Cepat",
      sd: {
        acts: ["Menggosok gigi sebelum tidur", "Mendengarkan dongeng", "Membersihkan tempat tidur", "Tidur lebih awal"],
        bens: ["Membantu organ tubuh pulih dan berfungsi optimal", "Memulihkan kondisi mental dan emosional", "Menjaga keseimbangan antara aktivitas dan istirahat", "Meningkatkan produktivitas keesokan hari"]
      },
      smp: [
        { q: "Apa manfaat utama tidur lebih awal?", a: "Meningkatkan produktivitas keesokan hari" },
        { q: "Mendengarkan dongeng sebelum tidur membantu...", a: "Memulihkan kondisi mental dan emosional" },
        { q: "Membersihkan tempat tidur penting untuk...", a: "Menjaga keseimbangan aktivitas dan istirahat" },
        { q: "Fungsi organ tubuh pulih optimal jika kita...", a: "Tidur cepat dan berkualitas" },
        { q: "Persiapan tidur seperti gosok gigi melatih...", a: "Kebiasaan baik sebelum istirahat" }
      ],
      sma: [
        { prob: "Sering mengantuk dan tidak produktif di sekolah.", sol: "Tidur lebih awal agar produktivitas meningkat esok hari.", wrong: ["Minum kopi banyak-banyak", "Tidur saat pelajaran"] },
        { prob: "Emosi tidak stabil dan mudah marah.", sol: "Istirahat cukup untuk pulihkan kondisi mental emosional.", wrong: ["Melampiaskan amarah", "Main game sampai pagi"] },
        { prob: "Badan terasa pegal dan tidak fit saat bangun.", sol: "Tidur cukup bantu organ tubuh pulih optimal.", wrong: ["Langsung olahraga berat", "Minum obat pereda nyeri"] }
      ]
    }
  };

  const CHARACTERS = [
    { id: "WIRA", name: "Wira", image: "https://i.imgur.com/MSiJjWh.png", style: "Arsitek Pemberani" },
    { id: "PERTIWI", name: "Pertiwi", image: "https://i.imgur.com/4ZGqnf8.png", style: "Arsitek Alam" },
    { id: "BIMA", name: "Bima", image: "https://i.imgur.com/TGR18dQ.png", style: "Arsitek Teknologi" }
  ];

  const ISLAND_CONFIG = [
    { id: "ISL_01", image: "https://i.imgur.com/mcu8Sy2.jpeg", part: "PART_FOUNDATION" },
    { id: "ISL_02", image: "https://i.imgur.com/YvTIfpK.jpeg", part: "PART_ROOF" },
    { id: "ISL_03", image: "https://i.imgur.com/j2xbk9V.jpeg", part: "PART_KITCHEN_GARDEN" }, 
    { id: "ISL_04", image: "https://i.imgur.com/LCu0X7f.jpeg", part: "PART_WALLS" }, 
    { id: "ISL_05", image: "https://i.imgur.com/IjCxSnh.jpeg", part: "PART_WINDOWS" },
    { id: "ISL_06", image: "https://i.imgur.com/BOm1GDh.jpeg", part: "PART_DOOR_LIVING" },
    { id: "ISL_07", image: "https://i.imgur.com/2JWvhPq.jpeg", part: "PART_BEDROOM" }
  ];

  const HOUSE_PARTS = {
    PART_FOUNDATION: { name: "Pondasi Disiplin" },
    PART_WALLS: { name: "Dinding Kekuatan" },
    PART_ROOF: { name: "Atap Doa" },
    PART_KITCHEN_GARDEN: { name: "Kebun Energi" },
    PART_WINDOWS: { name: "Jendela Ilmu" },
    PART_DOOR_LIVING: { name: "Pintu Ramah" },
    PART_BEDROOM: { name: "Lampu Tidur" }
  };

  // Titik koordinat peta telah disesuaikan (Level 1, 6, dan 7)
  const islandPositions = [
    { top: '25%', left: '18%' }, // Lvl 1: Sedikit ke kanan (dari 13% ke 18%)
    { top: '70%', left: '25%' },
    { top: '25%', left: '38%' },
    { top: '70%', left: '51%' },
    { top: '25%', left: '65%' },
    { top: '70%', left: '73%' }, // Lvl 6: Sedikit ke kiri (dari 78% ke 73%)
    { top: '40%', left: '85%' }, // Lvl 7: Serong kiri bawah (dari top:25%, left:90% menjadi top:40%, left:85%)
  ];

  // ===== STATE =====
  let screen = "START";
  let selectedLevel = "SD"; // SD, SMP, SMA
  let numPlayers = 1;
  let players = [];
  let picked = [];
  let unlockedParts = [];
  let activeIslandId = null;
  let playerScores = {};
  
  // Turn Management
  let turnIndex = 0; 
  let questions = []; 
  let currentQuestionInTurn = 0; 

  let feedbackLock = false;

  // music
  let audio = null;
  let isMusicPlaying = false;

  // ===== HELPERS =====
  const $ = (id) => document.getElementById(id);

  function showScreen(name){
    screen = name;
    $("screenStart").style.display = (name==="START") ? "flex" : "none";
    $("screenLevel").style.display = (name==="LEVEL") ? "flex" : "none";
    $("screenMode").style.display  = (name==="MODE") ? "flex" : "none";
    $("screenChar").style.display  = (name==="CHAR") ? "flex" : "none";
    $("screenMap").style.display   = (name==="MAP") ? "flex" : "none";
    
    if (name === "FINISH") {
        $("screenFinish").style.display = "flex";
    } else {
        $("screenFinish").style.display = "none";
    }

    $("btnReset").style.display = (name==="MAP" || name==="FINISH") ? "inline-flex" : "none";
    $("btnMusic").style.display = (name==="START") ? "none" : "inline-flex";

    if(name === "MAP"){
        renderScoreBoard();
        $("scoreBoard").style.display = "flex";
    } else {
        $("scoreBoard").style.display = "none";
    }
  }

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function generateQuestions(islandId, questionsPerPlayer){
    const data = HABIT_DATA[islandId];
    const allHabitKeys = Object.keys(HABIT_DATA);
    let finalQs = []; 

    let availableIndices = [];
    if(selectedLevel === "SMP") {
        for(let i=0; i<data.smp.length; i++) availableIndices.push(i);
    } else if(selectedLevel === "SMA") {
        for(let i=0; i<data.sma.length; i++) availableIndices.push(i);
    }
    
    availableIndices = shuffle(availableIndices);
    let globalQIndex = 0; 

    players.forEach((player, pIndex) => {
        let playerQs = [];
        for(let k = 0; k < questionsPerPlayer; k++){
            let qObj = {};

            if(selectedLevel === "SD") {
                let type = (k % 2 === 0) ? "ACT" : "BEN";
                const correctItem = (type==="ACT")
                  ? data.sd.acts[Math.floor(Math.random()*data.sd.acts.length)]
                  : data.sd.bens[Math.floor(Math.random()*data.sd.bens.length)];

                const internalDistractor = (type==="ACT")
                  ? data.sd.bens[Math.floor(Math.random()*data.sd.bens.length)]
                  : data.sd.acts[Math.floor(Math.random()*data.sd.acts.length)];

                let externalDistractor = "";
                while(!externalDistractor){
                  const randomIsland = allHabitKeys[Math.floor(Math.random()*allHabitKeys.length)];
                  if(randomIsland === islandId) continue;
                  const wrongPool = (type==="ACT") ? HABIT_DATA[randomIsland].sd.acts : HABIT_DATA[randomIsland].sd.bens;
                  const wrongItem = wrongPool[Math.floor(Math.random()*wrongPool.length)];
                  if(wrongItem !== correctItem && wrongItem !== internalDistractor) externalDistractor = wrongItem;
                }

                qObj = {
                    badge: (type==="ACT") ? "CONTOH KEGIATAN" : "MANFAAT",
                    text: (type==="ACT") ? `Contoh kegiatan ${data.habit} adalah...` : `Manfaat dari ${data.habit} adalah...`,
                    options: shuffle([correctItem, internalDistractor, externalDistractor]),
                    correct: correctItem,
                    assignedPlayerId: player.id
                };
            }
            else if(selectedLevel === "SMP") {
                let pairIndex = 0;
                if(globalQIndex < availableIndices.length) {
                    pairIndex = availableIndices[globalQIndex];
                    globalQIndex++;
                } else {
                    pairIndex = Math.floor(Math.random() * data.smp.length);
                }
                
                const pair = data.smp[pairIndex];
                const correctItem = pair.a;
                
                let internalDistractor = "";
                let safety = 0;
                while(!internalDistractor && safety < 10) {
                    safety++;
                    const randIdx = Math.floor(Math.random() * data.smp.length);
                    if(randIdx !== pairIndex) {
                        internalDistractor = data.smp[randIdx].a;
                    }
                }
                if(!internalDistractor) internalDistractor = "Jawaban tidak tersedia"; 

                let externalDistractor = "";
                while(!externalDistractor){
                  const randomIslandKey = allHabitKeys[Math.floor(Math.random()*allHabitKeys.length)];
                  if(randomIslandKey === islandId) continue;
                  const randomIslandData = HABIT_DATA[randomIslandKey];
                  const randomPair = randomIslandData.smp[Math.floor(Math.random() * randomIslandData.smp.length)];
                  const wrongItem = randomPair.a;
                  if(wrongItem !== correctItem && wrongItem !== internalDistractor) externalDistractor = wrongItem;
                }

                qObj = {
                    badge: "HUBUNGAN MANFAAT",
                    text: pair.q,
                    options: shuffle([correctItem, internalDistractor, externalDistractor]),
                    correct: correctItem,
                    assignedPlayerId: player.id
                };
            }
            else if(selectedLevel === "SMA") {
                let caseIndex = 0;
                if(globalQIndex < availableIndices.length) {
                    caseIndex = availableIndices[globalQIndex];
                    globalQIndex++;
                } else {
                    caseIndex = Math.floor(Math.random() * data.sma.length);
                }

                const caseData = data.sma[caseIndex];
                const internalDistractor = caseData.wrong[Math.floor(Math.random() * caseData.wrong.length)];

                let externalDistractor = "";
                while(!externalDistractor){
                    const randomIslandKey = allHabitKeys[Math.floor(Math.random()*allHabitKeys.length)];
                    if(randomIslandKey === islandId) continue;
                    const randomIslandData = HABIT_DATA[randomIslandKey];
                    const randomCase = randomIslandData.sma[Math.floor(Math.random() * randomIslandData.sma.length)];
                    const wrongItem = randomCase.sol; 
                    if(wrongItem !== caseData.sol && wrongItem !== internalDistractor) externalDistractor = wrongItem;
                }

                qObj = {
                    badge: "ANALISIS MASALAH",
                    text: `KASUS: "${caseData.prob}"\n\nSolusi terbaik adalah...`,
                    options: shuffle([caseData.sol, internalDistractor, externalDistractor]),
                    correct: caseData.sol,
                    assignedPlayerId: player.id
                };
            }

            playerQs.push(qObj);
        }
        finalQs.push(playerQs);
    });

    return finalQs;
  }

  function totalScore(){
    return Object.values(playerScores).reduce((a,b)=>a+b,0);
  }

  function renderScoreBoard() {
    const board = $("scoreBoard");
    board.innerHTML = "";
    
    if (!players || players.length === 0) return;

    let activePlayerId = null;
    if ($("modal").classList.contains("show")) {
        const currentPlayer = players[turnIndex];
        activePlayerId = currentPlayer.id;
    } else {
        activePlayerId = players[turnIndex].id;
    }

    players.forEach(p => {
        const score = playerScores[p.id] || 0;
        const isActive = (p.id === activePlayerId);
        
        const pill = document.createElement("div");
        pill.className = "score-pill" + (isActive ? " active" : "");
        pill.innerHTML = `
            <img src="${p.image}" alt="${p.name}">
            <span>
                <div style="font-size:11px; font-weight:700; color:#64748b; text-transform:uppercase; font-family:'Fredoka';">${p.name}</div>
                <div class="score-val">${score}</div>
            </span>
        `;
        board.appendChild(pill);
    });
  }

  function updateSidebar(){
    $("totalScore").textContent = totalScore();
    const pct = Math.round((unlockedParts.length / 7) * 100);
    $("progressFill").style.width = pct + "%";

    const mat = $("materials");
    mat.innerHTML = "";

    if(unlockedParts.length === 0){
      mat.innerHTML = '<div style="color:#64748b; font-weight:600; font-size:12px; font-style:italic;">Belum ada material.</div>';
      return;
    }

    unlockedParts.forEach(partId=>{
      const div = document.createElement("div");
      div.className = "matItem";
      div.innerHTML = '<span>' + HOUSE_PARTS[partId].name + '</span><span class="tagOk">‚úî</span>';
      mat.appendChild(div);
    });

    if(unlockedParts.length === 7){
      const done = document.createElement("div");
      done.className = "matItem";
      done.style.background = "#dcfce7";
      done.style.borderColor = "#22c55e";
      done.style.color = "#15803d";
      done.innerHTML = '<span style="font-weight:700;">RUMAH JADI!</span>';
      mat.appendChild(done);
    }
  }

  function renderCharacters(){
    const wrap = $("charWrap");
    wrap.innerHTML = "";
    CHARACTERS.forEach(ch=>{
      const isSelected = picked.some(p=>p.id===ch.id);
      const card = document.createElement("div");
      card.className = "charCard" + (isSelected ? " disabled" : "");
      card.innerHTML = `
        <div class="charImg"><img src="${ch.image}" alt="${ch.name}"></div>
        <h3 class="charName">${ch.name}</h3>
        <p class="charStyle">${ch.style}</p>
        ${isSelected ? '<div class="pickedBadge">‚úì</div>' : ''}
      `;
      card.onclick = () => {
        if(isSelected) return;
        picked.push(ch);
        if(picked.length === numPlayers){
          players = picked.slice();
          playerScores = {};
          players.forEach(p=>playerScores[p.id]=0);
          turnIndex = 0;
          unlockedParts = [];
          activeIslandId = null;
          renderMap();
          updateSidebar();
          showScreen("MAP");
          return;
        }
        updatePickUI();
        renderCharacters();
      };
      wrap.appendChild(card);
    });
    updatePickDots();
  }

  function updatePickUI(){
    const n = picked.length + 1;
    $("pickInfo").textContent = "Pemain " + n + ", pilih jagoanmu!";
  }

  function updatePickDots(){
    const dots = $("pickDots");
    dots.innerHTML = "";
    for(let i=0;i<numPlayers;i++){
      const d = document.createElement("div");
      d.style.width = "14px";
      d.style.height = "14px";
      d.style.borderRadius = "999px";
      d.style.border = "2px solid rgba(255,255,255,0.8)";
      d.style.boxShadow = "inset 0 2px 4px rgba(0,0,0,0.1)";
      d.style.background = (i < picked.length) ? "#f59e0b" : "rgba(255,255,255,0.5)";
      d.style.transform = (i < picked.length) ? "scale(1.2)" : "scale(1)";
      dots.appendChild(d);
    }
  }

  function renderMap(){
    const mapArea = $("mapArea");
    const olds = mapArea.querySelectorAll(".node");
    olds.forEach(n=>n.remove());

    ISLAND_CONFIG.forEach((isl, idx)=>{
      const pos = islandPositions[idx];
      const isUnlocked = idx <= unlockedParts.length;
      const isDone = unlockedParts.includes(isl.part);
      const isNext = idx === unlockedParts.length;

      const node = document.createElement("div");
      node.className = "node";
      node.style.top = pos.top;
      node.style.left = pos.left;

      if(!isUnlocked) node.classList.add("locked");
      if(isDone) node.classList.add("done");
      if(isNext && !isDone) node.classList.add("next");

      node.textContent = (idx+1);

      const label = document.createElement("div");
      label.className = "label";
      label.textContent = HABIT_DATA[isl.id].habit;
      node.appendChild(label);

      node.onclick = () => {
        if(!isUnlocked || isDone) return;
        openIsland(isl.id);
      };
      mapArea.appendChild(node);
    });
  }

  function openIsland(islandId){
    activeIslandId = islandId;
    const isl = ISLAND_CONFIG.find(i=>i.id===islandId);
    const data = HABIT_DATA[islandId];

    $("modalCard").style.backgroundImage = "url('" + isl.image + "')";
    $("islandName").textContent = data.name;
    $("islandHabit").textContent = data.habit;

    const QUESTIONS_PER_PLAYER = 3; 
    questions = generateQuestions(islandId, QUESTIONS_PER_PLAYER);
    
    turnIndex = 0; 
    currentQuestionInTurn = 0; 

    $("modal").classList.add("show");
    renderScoreBoard();
    showTurnPopup();
  }

  function closeModal(){
    $("modal").classList.remove("show");
    activeIslandId = null;
    renderScoreBoard();
  }

  function showTurnPopup(){
    const currentPlayer = players[turnIndex];
    $("turnImg").src = currentPlayer.image;
    $("turnName").textContent = currentPlayer.name;
    $("turnPopup").classList.add("show");
    renderScoreBoard();
  }

  function hideTurnPopup(){
    $("turnPopup").classList.remove("show");
    renderQuestion();
  }

  function renderQuestion(){
    feedbackLock = false;
    const q = questions[turnIndex][currentQuestionInTurn];

    $("quizBadge").textContent = q.badge; 
    $("qText").innerText = q.text; 

    const opts = $("options");
    opts.innerHTML = "";

    q.options.forEach(opt=>{
      const btn = document.createElement("button");
      btn.className = "optBtn";
      btn.textContent = opt;
      btn.onclick = () => handleAnswer(opt);
      opts.appendChild(btn);
    });
  }

  function handleAnswer(option){
    if(feedbackLock) return;
    feedbackLock = true;

    const q = questions[turnIndex][currentQuestionInTurn];
    const currentPlayer = players[turnIndex];

    const isCorrect = (option === q.correct);
    let points = 0;

    if (isCorrect) {
      points = 10;
      playSfx('correct'); // Efek suara Benar
    } else {
      points = -5;
      playSfx('wrong'); // Efek suara Salah
    }

    playerScores[currentPlayer.id] = Math.max(0, (playerScores[currentPlayer.id] || 0) + points);
    
    renderScoreBoard();

    const btns = Array.from($("options").querySelectorAll("button"));
    btns.forEach(b=>{
      if(b.textContent === q.correct){
        b.classList.add("good");
      } else if(b.textContent === option && !isCorrect){
        b.classList.add("bad");
      } else {
        b.classList.add("dim");
      }
      b.disabled = true;
    });

    setTimeout(()=>{
        currentQuestionInTurn++;
        
        if (currentQuestionInTurn < 3) {
            renderQuestion();
        } else {
            turnIndex++;
            currentQuestionInTurn = 0;

            if (turnIndex < players.length) {
                showTurnPopup();
            } else {
                const isl = ISLAND_CONFIG.find(i=>i.id===activeIslandId);
                if(isl && !unlockedParts.includes(isl.part)){
                  unlockedParts.push(isl.part);
                  
                  // Putar efek pulau selesai jika ini bukan pulau terakhir
                  if (unlockedParts.length < 7) {
                      playSfx('island');
                  }
                }

                if(unlockedParts.length === 7) {
                     turnIndex = 0;
                     renderMap();
                     updateSidebar(); 
                     closeModal();
                     setTimeout(showFinishScreen, 600);
                     return;
                }

                turnIndex = 0; 
                renderMap();
                updateSidebar();
                closeModal();
            }
        }
    }, 1500);
  }

  function showFinishScreen(){
    playSfx('win'); // Efek suara Menang di akhir game
    
    const sortedPlayers = players.slice().sort((a,b) => {
        return (playerScores[b.id]||0) - (playerScores[a.id]||0);
    });

    const winner = sortedPlayers[0];
    const winnerScore = playerScores[winner.id]||0;

    const finishHTML = `
      <div class="winnerSection">
        <div class="winnerTitle">SELAMAT! KAMU ADALAH</div>
        <div class="winnerRank">ANAK INDONESIA HEBAT</div>
        <div class="winnerAvatar">
            <img src="${winner.image}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">
        </div>
        <div class="winnerName">${winner.name}</div>
        <div style="font-weight:700; color:#64748b; margin-top:8px;">Skor Tertinggi: ${winnerScore}</div>
      </div>

      <div class="scoreTable">
        ${sortedPlayers.map(p => `
          <div class="scoreRow">
             <div style="display:flex; align-items:center;">
               <img src="${p.image}">
               <div class="pName">${p.name}</div>
             </div>
             <div class="pScore">${playerScores[p.id]||0}</div>
          </div>
        `).join('')}
      </div>

      <button class="btn" onclick="resetGame()">üîÑ MAIN LAGI</button>
    `;
    
    $("finishContent").innerHTML = finishHTML;
    showScreen("FINISH");
  }

  function resetGame(){
    document.getElementById('customConfirmModal').style.display = 'flex';
  }

  function executeReset() {
    // Sembunyikan semua overlay yang mungkin menutupi halaman START
    document.getElementById('customConfirmModal').style.display = 'none';
    document.getElementById('modal').classList.remove('show');
    document.getElementById('turnPopup').classList.remove('show');
    document.getElementById('screenFinish').style.display = 'none';
    
    // Reset state game
    numPlayers = 1;
    players = [];
    picked = [];
    unlockedParts = [];
    activeIslandId = null;
    playerScores = {};
    turnIndex = 0;
    selectedLevel = "SD"; 
    
    showScreen("START");
  }

  function initMusic(){
    if(audio) return;
    audio = new Audio(MUSIC_URL);
    audio.loop = true;
    audio.volume = 0.5;
  }
  function updateMusicBtn(){
    $("btnMusic").textContent = isMusicPlaying ? "üîä Musik" : "üîá Musik";
  }
  function startMusic(){
    initMusic();
    if(!audio) return;
    audio.play().then(()=>{
      isMusicPlaying = true;
      updateMusicBtn();
    }).catch(()=>{
      isMusicPlaying = false;
      updateMusicBtn();
    });
  }
  function toggleMusic(){
    initMusic();
    if(!audio) return;
    if(isMusicPlaying){
      audio.pause();
      isMusicPlaying = false;
    }else{
      audio.play().then(()=>{ isMusicPlaying = true; }).catch(()=>{ isMusicPlaying = false; });
    }
    updateMusicBtn();
  }

  // ===== LEVEL SELECTION =====
  function selectLevel(lvl){
    selectedLevel = lvl;
    showScreen("MODE");
  }

  // ===== FULLSCREEN LOGIC =====
  function toggleFullScreen() {
    const doc = document.documentElement;
    const btn = $("btnFull");
    if (!document.fullscreenElement && !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
      if (doc.requestFullscreen) doc.requestFullscreen();
      else if (doc.msRequestFullscreen) doc.msRequestFullscreen();
      else if (doc.mozRequestFullScreen) doc.mozRequestFullScreen();
      else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
      btn.textContent = "‚õ∂ KELUAR";
      btn.classList.add("fs-active");
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
      else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      btn.textContent = "‚õ∂ LAYAR PENUH";
      btn.classList.remove("fs-active");
    }
  }
  document.addEventListener('fullscreenchange', checkFS);
  document.addEventListener('webkitfullscreenchange', checkFS);
  document.addEventListener('mozfullscreenchange', checkFS);
  document.addEventListener('MSFullscreenChange', checkFS);
  function checkFS(){
    const btn = $("btnFull");
    if (!document.fullscreenElement && !document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement) {
      btn.textContent = "‚õ∂ LAYAR PENUH";
      btn.classList.remove("fs-active");
    } else {
      btn.textContent = "‚õ∂ KELUAR";
      btn.classList.add("fs-active");
    }
  }

  // ===== EVENTS =====
  $("btnFull").onclick = toggleFullScreen;
  $("btnStart").onclick = () => { 
      initAudioContext(); // Mengizinkan Web Audio API aktif
      showScreen("LEVEL"); 
      startMusic(); 
  };
  $("btnBackToStart").onclick = () => showScreen("START");
  $("btnBackToLevel").onclick = () => showScreen("LEVEL");
  $("btnBackToMode").onclick = () => showScreen("MODE");

  document.querySelectorAll("[data-mode]").forEach(el=>{
    el.onclick = () => {
      numPlayers = parseInt(el.getAttribute("data-mode"), 10);
      picked = [];
      updatePickUI();
      renderCharacters();
      showScreen("CHAR");
    };
  });

  $("btnReset").onclick = resetGame;
  $("btnMusic").onclick = toggleMusic;
  $("btnCloseModal").onclick = closeModal;
  $("btnTurnReady").onclick = hideTurnPopup;

  // ===== START =====
  showScreen("START");
  updateMusicBtn();
</script>

</body>
</html>
